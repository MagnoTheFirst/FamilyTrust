# FamilyTrust

## Sequenzdiagramm

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant API
    participant DB
    User->>Frontend: Client makes a request to either record a stock purchase or a stock sell
    Frontend->>API: Send Request to backend.
    API->>DB: Query Data
    DB-->>API: Return Data
    API-->>User: Send Response
```

## üìä PROJEKT STATUS ANALYSE (Stand: 2025-01-06)

### üéØ **Kernfunktionalit√§ten Status**
- ‚úÖ **Account Management**: Basis-Funktionen (Erstellen, L√∂schen, Anzeigen)
- ‚úÖ **Cash Flow Transaktionen**: Einzahlungen, Abhebungen, Dividenden
- ‚úÖ **Asset Kauf**: Grundlegende Aktien-K√§ufe funktional
- ‚ö†Ô∏è **Asset Verkauf**: Backend fehlerhaft, Frontend nicht implementiert
- ‚ùå **User Management**: Komplett fehlend
- ‚ùå **Portfolio Analytics**: Keine Gewinn/Verlust-Berechnungen
- ‚ùå **Admin Funktionen**: Alle Endpoints returnen `null`

### üîí **Security Status**
- ‚úÖ **Keycloak Integration**: OAuth2 Login implementiert
- ‚ö†Ô∏è **Session Management**: Funktional aber verbesserungsf√§hig
- ‚ùå **CSRF Protection**: Deaktiviert (Sicherheitsrisiko)
- ‚ùå **Input Validation**: Nicht implementiert
- ‚ùå **Authorization**: Keine rollenbasierte Zugriffskontrolle

### üß™ **Test Coverage**
- ‚ùå **Unit Tests**: Nur 1 Basis-Test vorhanden
- ‚ùå **Integration Tests**: Nicht vorhanden
- ‚ùå **Frontend Tests**: Nicht vorhanden
- ‚ùå **API Tests**: Minimale HTTP-Test-Dateien

---

## TODO Liste - Offene Aufgaben und Bugs

### üî¥ KRITISCHE SECURITY VULNERABILITIES (SOFORT BEHEBEN)

#### **Authentication & Authorization L√ºcken**
- **CSRF Protection deaktiviert** (`config/SecurityConfig.java:48`)
  - Anwendung anf√§llig f√ºr Cross-Site Request Forgery Angriffe
  - Risiko: Unbefugte Aktionen im Namen authentifizierter Benutzer

- **Input Validation komplett fehlend** (Alle Controller)
  - Keine Validierung von Benutzereingaben
  - Risiko: SQL Injection, XSS, Data Corruption
  - Betrifft: Account-Erstellung, Asset-Transaktionen, alle API-Endpoints

- **Information Disclosure** (Multiple Dateien)
  - Sensitive Daten in Console-Logs (`AssetManagementService.java:122`)
  - Detaillierte Fehlermeldungen an Frontend-User
  - Risiko: Systemarchitektur-Details preisgegeben

#### **Session & Authentication Issues**
- **Session Hijacking m√∂glich** (`config/SecurityConfig.java`)
  - Keine Session-Timeout-Konfiguration
  - Keine sichere Cookie-Konfiguration
  - Risiko: Unbefugter Zugriff nach Session-Theft

### üî¥ Kritische Functional Bugs (Sofort beheben)

#### Backend
- **AdminController komplett nicht funktionsf√§hig** (`controllers/AdminController.java:16,26,30,36`)
  - Alle Methoden returnen `null` statt tats√§chliche Funktionalit√§t
  - Keine Service-Integration
  - Fehlende Authentifizierung/Autorisierung

- **Asset-Pr√§senz-Logik invertiert** (`services/AssetManagementService.java:206-208`)
  - `isAssetPresent()` returnt `true` wenn Asset NICHT vorhanden ist
  - F√ºhrt zu fehlerhafter Kauf/Verkauf-Logik

- **Account Balance Persistence Bug** (`services/AssetManagementService.java:151`)
  - `account.getAvailableMoney().add()` persistiert nicht
  - F√ºhrt zu falschen Account-Balances und Portfolio-Werten
  - **Kritisch**: Finanzielle Daten inkonsistent

- **Asset Balance Updates defekt** (`entities/Asset.java:112-114`)
  - `updateBalance()` Methode ist leer implementiert
  - Asset-Balances werden nie aktualisiert
  - **Kritisch**: Portfolio-Werte komplett falsch

- **Verkaufs-Transaktionen fehlerhaft** (`services/AssetManagementService.java:147-151`)
  - Negative Mengen in Sell-Transaktionen
  - Account-Balance-Updates werden nicht gespeichert
  - **Kritisch**: Verk√§ufe funktionieren nicht korrekt

#### Frontend
- **Verkaufs-Funktionalit√§t fehlt komplett** (`views/AccountDetailsView.vue:372-374`)
  - `sellAsset` Funktion nur als TODO implementiert
  - Nutzer k√∂nnen keine Assets verkaufen

- **Debug-Code in Produktion** (`views/PortfolioDashboard.vue:13,20,27`)
  - Debug-Informationen werden mit rotem Text angezeigt
  - Unprofessionelle Darstellung

- **Inkonsistente API-Nutzung** (`components/AssetBuySellForm.vue:25-37`)
  - Direkter axios-Aufruf statt zentraler API-Service
  - Hardcodierte URLs

### üî¥ KRITISCHE ARCHITEKTUR-PROBLEME

#### **Database Design Issues**
- **Keine User Entity** 
  - Multi-User-System nicht implementiert
  - Hardcodierte Test-User-ID verwendet
  - **Kritisch**: Produktions-untauglich

- **Fehlende Transaktions-Integrit√§t**
  - Keine proper Transaction Boundaries
  - Asset + Account Updates nicht atomisch
  - **Kritisch**: Data Corruption bei Concurrent Access

- **Inkonsistente Datentypen**
  - Mix von `BigDecimal` und `Double` f√ºr Geldbetr√§ge
  - **Kritisch**: Precision Loss in finanziellen Berechnungen

### üü° WICHTIGE SECURITY VERBESSERUNGEN ERFORDERLICH

#### **Authorization & Access Control**
- **Keine rollenbasierte Autorisierung**
  - Alle authentifizierten User haben gleiche Rechte
  - Keine Admin/User-Unterscheidung
  - Risiko: Privilege Escalation

- **Missing API Endpoint Protection**
  - Keine Method-Level Security
  - Fehlende @PreAuthorize Annotations
  - Risiko: Unberechtigter Datenzugriff

### üü° Wichtige Fehlende Features

#### Backend
- **UserController komplett leer** (`controllers/UserController.java:19-23`)
  - Keine Methoden implementiert
  - User-Management fehlt vollst√§ndig

- **Unvollst√§ndige Asset-Transaktionstypen** (`services/AssetManagementService.java:74-88`)
  - ETF, Physische Assets, Krypto returnen `null`
  - Nur STOCK_BUY und STOCK_SELL implementiert

- **Fehlende Validierungen**
  - Keine √úberpr√ºfung f√ºr negative Mengen
  - Keine Validierung f√ºr ausreichendes Guthaben
  - Keine Asset-Existenz-Pr√ºfung vor Verkauf

#### Frontend
- **Account-Bearbeitung nicht implementiert** (`views/AccountsView.vue:166-169`)
  - Nutzer k√∂nnen Account-Details nicht √§ndern
  - `updateAccount` Funktionalit√§t vorhanden aber nicht genutzt

- **Hardcodierte User-ID** (Multiple Dateien)
  - User-ID ist fest auf Test-User gesetzt
  - Kein Authentifizierungssystem

- **Fehlende Fehlerbehandlung**
  - Unzureichende Fehlerbehandlung bei API-Aufrufen
  - Keine Benutzer-freundlichen Fehlermeldungen

### üü¢ Architektur-Verbesserungen

#### Backend
- **Inkonsistente Datentypen**
  - Mix aus `BigDecimal` und `Double` f√ºr Geldbetr√§ge
  - Asset-Mengen sollten `BigDecimal` f√ºr Pr√§zision verwenden

- **Fehlende Transaktions-Konsistenz**
  - Asset-Transaktionen aktualisieren Account-Balance nicht korrekt
  - Fehlende Rollback-Mechanismen

- **Test-Abdeckung unzureichend**
  - Nur grundlegende Context-Loading-Tests
  - Keine Unit-Tests f√ºr Services/Controller
  - Keine Integrationstests

#### Frontend
- **Doppelte Dashboard-Views**
  - `Dashboard.vue` und `PortfolioDashboard.vue` mit √§hnlichem Zweck
  - Code-Duplikation

- **Inkonsistente Store-Struktur**
  - `accountStore.js` nicht im `stores/` Verzeichnis
  - Architektur-Inkonsistenz

- **Fehlende TypeScript-Unterst√ºtzung**
  - Keine TypeScript-Konfiguration
  - Potenzielle Laufzeitfehler

### üü° PERFORMANCE & SCALABILITY ISSUES

#### **Database Performance Problems**
- **N+1 Query Problems**
  - Asset Loading nicht optimiert
  - Multiple DB-Calls f√ºr Related Data
  - Impact: Schlechte Performance bei vielen Assets

- **Keine Caching Strategy**
  - Repeated Database Queries
  - Static Data wird immer neu geladen
  - Impact: Unn√∂tige Server-Last

#### **Frontend Performance Issues**
- **Keine Lazy Loading**
  - Alle Account-Daten werden upfront geladen
  - Impact: Langsame Initial Page Load

### üîµ Fehlende Kern-Features

#### **Complete Missing Core Systems**
- **User Management System fehlt komplett**
  - Keine User Registration/Profile
  - Keine User-spezifischen Permissions
  - **Impact**: System ist Single-User nur

- **Asset Selling System dysfunktional**
  - Frontend Sell-Button nicht implementiert
  - Backend Sell-Logic fehlerhaft
  - **Impact**: Core Portfolio-Feature nicht nutzbar

#### Portfolio-Management
- **Profit/Loss-Berechnungen fehlen**
  - Keine Gewinn/Verlust-Analysen
  - Keine Portfolio-Performance-Metriken

- **Asset-Transaktionshistorie unvollst√§ndig**
  - Transaktionen werden geladen aber nicht richtig angezeigt
  - Fehlende Filterung und Aggregation

- **Account-zu-Account-Transfers fehlen**
  - Keine √úberweisungen zwischen Accounts
  - Fehlende Transfer-Validierung

#### Benutzerfreundlichkeit
- **Deutsch/Englisch-Mischung**
  - Inkonsistente Sprache in der UI
  - Fehlende Internationalisierung

- **Fehlende Echtzeit-Updates**
  - Keine aktuellen Asset-Preise
  - Fehlende WebSocket/Polling-Integration

- **Unzureichende Formular-Validierung**
  - Minimale Validierung in Formularen
  - Potenzielle Datenintegrit√§tsprobleme

### üü¶ Sicherheits-Verbesserungen

- **API-Konfiguration exponiert**
  - API-Endpoints im Client-Code sichtbar
  - Fehlende umgebungsbasierte Konfiguration

- **Fehler-Informationen preisgegeben**
  - Detaillierte Fehlermeldungen f√ºr Nutzer sichtbar
  - Potenzielle Informationsleckage

- **Fehlende Authentifizierung**
  - Keine echte Benutzer-Authentifizierung
  - Autorisierung nicht implementiert

### üö® BUSINESS IMPACT ASSESSMENT

#### **Revenue Impact (Hoch)**
- **Asset Selling nicht funktional** ‚Üí Kunde k√∂nnen Gewinne nicht realisieren
- **Portfolio Analytics fehlen** ‚Üí Keine Investment-Entscheidungsgrundlage
- **Multi-User System fehlt** ‚Üí Nicht skalierbar f√ºr Familien

#### **Security Risk (Kritisch)**
- **CSRF Attacks m√∂glich** ‚Üí Finanzielle Transaktionen gef√§hrdet  
- **Data Injection m√∂glich** ‚Üí Komplette Datenbankgef√§hrdung
- **Session Hijacking m√∂glich** ‚Üí Unbefugter Account-Zugriff

#### **Operational Risk (Hoch)**
- **Data Corruption durch Race Conditions** ‚Üí Falsche Finanz-Daten
- **No Rollback Mechanisms** ‚Üí Unumkehrbare Datenverluste
- **Missing Monitoring** ‚Üí Probleme unentdeckt

---

## üéØ ACTION PLAN & IMPLEMENTIERUNGS-PRIORIT√ÑTEN

### üìã Implementierungs-Priorit√§ten

#### üö® SECURITY EMERGENCY FIXES (Heute)
1. **CSRF Protection aktivieren** (`SecurityConfig.java`)
   ```java
   .csrf(csrf -> csrf.csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse()))
   ```
2. **Input Validation hinzuf√ºgen** (Alle Controllers)
   ```java
   @Valid @RequestBody CreateAccountRequest request
   ```
3. **Sensitive Logging entfernen** (Alle `System.out.println` mit Financial Data)

#### üî¥ CRITICAL BUG FIXES (Diese Woche)
1. `isAssetPresent()` Logik-Inversion beheben
2. Asset-Balance-Updates implementieren
3. Verkaufs-Funktionalit√§t im Frontend implementieren
4. **Account Balance Persistence Fix** (`AssetManagementService.java:151`)
   ```java
   account.setAvailableMoney(account.getAvailableMoney().add(amount));
   accountRepository.save(account); // ADD THIS
   ```
5. **AdminController Methoden implementieren** (Alle `return null;` ersetzen)
6. **Asset Balance Updates implementieren** (`Asset.java:112-114`)
7. **Frontend Sell Functionality** (`AccountDetailsView.vue:372-374`)

#### üü° ESSENTIAL FEATURES (1-2 Wochen)
1. User-Entity und Management implementieren
2. Asset-Transaktionstypen vervollst√§ndigen
3. Umfassende Validierungsschicht hinzuf√ºgen
4. Zentrale Fehlerbehandlung implementieren
5. **User Management System** (Complete User Entity + Controller)
6. **Method-Level Security** (Add @PreAuthorize annotations)
7. **Transaction Boundaries** (Add @Transactional properly)
8. **Basic Test Coverage** (Unit Tests f√ºr Services)

#### üîµ BUSINESS VALUE FEATURES (1-2 Monate)
1. Portfolio-Analysen implementieren
2. Transaktionshistorie vervollst√§ndigen
3. Account-Transfers implementieren
4. Authentifizierungssystem entwickeln
5. **Real-time Price Integration** (External API f√ºr Asset Prices)
6. **Advanced Portfolio Analytics** (ROI, Performance Tracking)
7. **Multi-Asset Support** (ETF, Crypto, Physical Assets completion)

#### üü¢ ENHANCEMENT FEATURES (3+ Monate)
1. Umfassende Test-Suite entwickeln
2. Echtzeit-Updates implementieren
3. Internationalisierung hinzuf√ºgen
4. Barrierefreiheit verbessern
5. **Performance Optimization** (Caching, Lazy Loading)
6. **Advanced Security Features** (2FA, Audit Logging)
7. **Mobile App Development**

---

## üìà ERFOLGSMESSUNG & KPIs

### **Security KPIs**
- ‚úÖ CSRF Protection: Aktiviert
- ‚úÖ Input Validation: 100% Coverage
- ‚úÖ Auth/Authorization: Role-based implementiert
- ‚úÖ Sensitive Data: Keine Logs

### **Functionality KPIs** 
- ‚úÖ Asset Selling: Vollst√§ndig funktional
- ‚úÖ Account Balances: Immer korrekt
- ‚úÖ Admin Functions: Alle implementiert
- ‚úÖ User Management: Multi-User Support

### **Quality KPIs**
- ‚úÖ Test Coverage: >80%
- ‚úÖ Bug Count: <5 bekannte Bugs
- ‚úÖ Performance: <2s Page Load
- ‚úÖ Availability: >99.5%

**FAZIT**: FamilyTrust hat solide Basis, ben√∂tigt aber sofortige Security-Fixes und kritische Bug-Behebungen vor Production-Deployment.
